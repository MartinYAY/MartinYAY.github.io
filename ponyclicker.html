<!doctype html>
<html>
<head>
  <title>Pony Clicker</title>
  <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
  <meta charset="utf-8" />
  <meta name="description" content="Pony Clicker v0.1 by Cloud Hop" />
  <meta name="copyright" content="Copyright (c)2015 Cloud Hop" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" type="text/css" href="ponyclicker.css" media="screen"/>
  <link href='https://fonts.googleapis.com/css?family=Open+Sans:700,400' rel='stylesheet' type='text/css' />
</head>
<body onresize="ResizeCanvas();" onload="doOnLoad();">
  <div class="container">
    <div id="ponyboard">
      <canvas id="canvas" width="100" height="100"></canvas>
      <div id="ponybg" class="bg">
      <img id="img_rays" style="display:none;" src="rays.svg" alt=""/>
      <img id="img_ground" style="display:none;" src="ground.svg" alt=""/>
      </div>
      <div class="ponies">
        <canvas id="canvaslines" width="520" height="520" style="position:relative;background:transparent;left:-260px;top:-260px;"></canvas>
        <div id="ponywrapper"></div>
      </div>
      <div id="score"><span id="scorenum">0 Sonrisas</span><div id="SPS">+0.1 por segundo</div></div>
      <div class="newsactive"><p><span id="news0" class="inactive">Noticias: cosas pasan</span></p><p><span id="news1" class="inactive">Noticias: otras cosas pasan</span></p></div>
    </div>
  </div>
  <div class="button" id="menubutton" onclick="ShowMenu(true);">Menú &raquo;</div>
  <div id="menu" class="menu">
  <div class="button" onclick="ShowMenu(false);">Menú &laquo;</div>
  <div class="button" onclick="EarnAchievement(200); SaveGame()" title="Guardar el progreso (se guarda automáticamente cada 60 segundos).">Guardar</div>
  <div class="button" onclick="EarnAchievement(201); document.getElementById('exportarea').innerHTML = ExportGame(); document.getElementById('exportwindow').style.display='inline-block';">Exportar</div>
  <div class="button" onclick="document.getElementById('credits').style.display='inline-block';">Créditos</div>
    <hr/>
    <input type="checkbox" id="EnableEffects" onchange="GetSettings()" />
    <label for="EnableEffects" title="Activa los efectos animados en el fondo.">Activar efectos de fondo</label>
    <br/><input type="checkbox" id="EnableFocus" onchange="GetSettings()" />
    <label for="EnableFocus" title="Reduce la frecuencia de actualización del juego cuando no se centra por lo que utiliza menos recursos.'">Minimizar uso de FPS</label>
    <br/><input type="checkbox" id="EnableWarn" onchange="GetSettings()" />
    <label for="EnableWarn" title="Poner un mensaje de advertencia antes de cerrar la ventana.">Advertencia antes de cerrar ventana</label>
      <hr/>
      Sonrisas Disponibles: <span id="stat_cursmiles">0</span>
      <br/>Sonrisas Totales: <span id="stat_totalsmiles">0</span>
      <br/>Sonrisas Por Segundo: <span id="stat_SPS">0</span>
      <br/>Clicks a Ponis: <span id="stat_clicks">0</span>
      <br/>Sonrisas Por Click: <span id="stat_SPC">0</span>
      <br/>Edificios Adquiridos: <span id="stat_buildings">0</span>
      <br/>Tiempo Jugado: <span id="stat_time">0</span>
      <br/>Muffins: <span id="stat_muffins">0</span> <span class="fade" style="display:none;">(<span id="stat_achievementmuffins">0</span> de logros)</span>
      <hr/>
      <div class="button" onclick="var x = window.prompt('Paste your exported game data here to import it. WARNING: This will overwrite your current game, even if the data is corrupt! Be sure you export your current game if you don\'t want to lose anything!',''); if(x!==null) { ImportGame(x); }">Import</div>
      <div class="button" onclick="if(window.confirm('This will destroy all your cookies, buildings, and upgrades, but you\'ll keep you\'re achievements and your muffins. Are you sure you want to do this?')) { ResetGame(); }" style="color:#c00">Reset</div>
      <div class="button" onclick="if(window.confirm('This will irreversibly wipe ALL your data, including all settings and all achievements! Are you certain you want to do this?')) { WipeAllData(); }" style="color:#c00">Wipe All Data</div>
      <hr/>
      Mejoras Adquiridas: <span id="upgrades_owned"></span>/<span id="upgrades_total"></span>
      <div id="upgradelist"></div>
      <hr/>
      Logros: <span id="achievements_owned"></span>/<span id="achievements_total"></span>
      <div id="achievements"></div>
      <hr/>
      <span style="display:block;font-size:70%;height:40px;"><a href="https://www.youtube.com/watch?v=otAFRGL4yX4" onclick="EarnAchievement(204);" target="_blank">The smile song is mandatory while playing this.</a></span>
    <div id="menuoverlay" class="tooltip">TEST</div>
  </div>
  <div class="store" id="storewrapper">
    <div class="title">Sugarcube Corner</div>
    <div class="upgrades" id="storeupgrades"></div>
    <ol id="store"></ol>
  </div>
  
  <div id="overlay" class="tooltip" data-item="2"></div>
  <div id="exportwindow" class="modal" style="width: 350px;display:none;margin-top:-150px;">
    <b>Exportar Archivo de Guardado</b>
    <hr/>
    Copia y pega esto en un lugar seguro. Para restaurar tu juego, clickea en el botón de importar y copia esto en la caja de diálogo.
    <br/>
    <br/><textarea id="exportarea" style="width:345px;height:150px;" readonly></textarea>
    <hr/>
    <div class="button" style="position:relative;left:50%;margin-left:-26px;" onclick="document.getElementById('exportwindow').style.display='none';">Done!</div>
    
  </div>
  <div id="credits" class="modal" style="width: 450px;display:none;margin-top:-200px;">
    <div class="button" style="position:absolute; right:0; top:0" onclick="document.getElementById('credits').style.display='none';">[x]</div>
    <b>Pony Clicker v0.8 <i>by</i> Cloud Hop</b>
    <hr/>
    <div>
      <a href="https://www.fimfiction.net/user/Cloud+Hop" target="_blank"><img style="float:left;" src="Cloudhop_goggles.png" alt="Cloud Hop Avatar" title="If you aren't careful, he might cute you to death." onclick="EarnAchievement(203);"/></a>
      Cloud Hop is a pegasus who works at the weather factory. He's also an <a href="http://blackhole12.blogspot.com/" target="_blank">applied mathematician</a> who makes <a href="https://github.com/blackhole12" target="_blank">games</a> and <a href="https://erikmcclure.bandcamp.com/album/aurora-theory" target="_blank">music</a>. Sometimes he puts them on the internet, corrupting it with the magic of friendship.
      <ul>
        <li><a href="https://www.fimfiction.net/user/Cloud+Hop" target="_blank">Fimfiction</a></li>
        <li><a href="http://blackhole12.newgrounds.com/" target="_blank">Newgrounds</a></li>
        <li><a href="https://soundcloud.com/blackhole12" target="_blank">Soundcloud</a></li>
        <li><a href="http://blackhole12.blogspot.com/" target="_blank">Blogger</a></li>
        <li><a href="https://www.youtube.com/channel/UCWC8FC5JryUP7I1oN1twBeQ" target="_blank">Youtube</a></li>
        <li><a href="https://twitter.com/blackhole0173" target="_blank">Twitter</a></li>
      </ul>
    </div>
    <p>
      Pony vectors by:
      <a href="https://90sigma.deviantart.com/art/Vector-All-the-Ponies-SVG-Files-302442314" target="_blank">90Sigma</a>,
      <a href="https://90sigma.deviantart.com/art/Princess-Cadance-Resources-302065204" target="_blank">90Sigma (again)</a>,
      <a href="https://ambassad0r.deviantart.com/art/Night-Glider-518678939" target="_blank">Ambassad0r</a>,
      <a href="https://destroyer735.deviantart.com/art/Octavia-375057218" target="_blank">destroyer735</a>,
      <a href="https://inuhoshi-to-darkpen.deviantart.com/art/Blossomforth-327154088" target="_blank">InuHoshi-to-DarkPen</a>,
      <a href="https://lman225.deviantart.com/art/Applebloom-490330115" target="_blank">LMan225</a>,
      <a href="https://nethear.deviantart.com/art/Rainbow-Dash-244004139" target="_blank">Nethear</a>,
      <a href="https://qazwsx302.deviantart.com/art/Sweetie-Belle-316776921" target="_blank">qazwsx302</a>,
      <a href="https://racefox.deviantart.com/art/Rarity-405280335" target="_blank">Racefox</a>,
      <a href="https://sakatagintoki117.deviantart.com/art/Shining-Armor-339746794" target="_blank">sakatagintoki117</a>,
      <a href="https://takua770.deviantart.com/art/Pinkie-Pie-PARTY-TIME-274526114" target="_blank">Takua770</a>,
      <a href="https://zutheskunk.deviantart.com/art/MLP-Resource-Dinky-Hooves-01-212564935" target="_blank">ZuTheSkunk</a>
      <br/>Pinkie Pie face taken from Fimfiction emoticons.
      <br/><strong>Playtesters:</strong> Fyrestorm, Karzafal, #fimfiction IRC
    </p>
    <hr/>
    <div class="footer"><a href="https://github.com/blackhole12/PonyClicker" target="_blank">Fork this project on Github</a></div>
  </div>
  <div id="upgradeoverlay" class="tooltip" data-item="-1"></div>
  <div id="mousetexts"></div>
  <div id="notices"></div>
  <div id="loadscreen"><div class="spinner"></div><div class="spinner2"></div><div class="spinner3"></div></div>
  <script type="text/javascript">
  function CreateGame() {
    return { 
      upgrades:[], // list of upgrade IDs that are owned
      upgradeHash:{},
      smiles:0,
      totalsmiles:0,
      SPC:1,
      SPS:0,
      shiftDown:false,
      totalTime:0,
      clicks:0,
      achievements:{}, // List of achievements as an object that we pretend is a hash.
      achievementcount:0, // We can't efficiently count properties so we store a length ourselves.
      muffins:0, // total muffin count, which is a combination of muffins gained from achievements and prestige.
      achievement_muffins:0, // Muffins from achievements only, recalculated every time an achievement is earned
      store:[1,0,0,0,0,0,0,0,0,0,0,0,0], // amount player has bought of each store item.
      ponyList:genPonyList(), // precalculated list of randomized ponies (so we can reconstruct them after a save/load)
      version:3, // incremented every time this object format changes so we know to deal with it.
      settings: {
        useCanvas:true,
        optimizeFocus:false,
        closingWarn:false,
      }
    };
  }
  
  var PonyList = ["pinkie.svg", "Adagio Dazzle.svg", "Aloe.svg", "Amethyst Star.svg", "Applebloom.svg", "Applejack.svg", "Aria Blaze.svg", "Babs Seed.svg", "Berry Punch.svg", "Big Macintosh.svg", "Blossomforth.svg", "Braeburn.svg", "Carrot Top.svg", "Cheerilee.svg", "Cheese Sandwich.svg", "Chrysalis.svg", "Cloudchaser.svg", "Coco Pommel.svg", "Colgate.svg", "Daring Do.svg", "Diamond Tiara.svg", "Dinky Doo.svg", "Ditsy Doo.svg", "Dr Whooves.svg", "Fancy Pants.svg", "Flam.svg", "Fleur de Lis.svg", "Flim.svg", "Flitter.svg", "Fluttershy.svg", "Hoity Toity.svg", "King Sombra.svg", "Lightning Dust.svg", "Lotus.svg", "Lyra Heartstrings.svg", "Maud Pie.svg", "Mrs Harshwhinny.svg", "Night Glider.svg", "octavia.svg", "Prince Blueblood.svg", "Princess Cadance.svg", "Princess Celestia.svg", "Princess Luna.svg", "Rainbow Dash.svg", "Rarity.svg", "Scootaloo.svg", "Shining Armor.svg", "Silver Spoon.svg", "Sonata Dusk.svg", "Starlight Glimmer.svg", "Sunset Shimmer.svg", "Sweetie Belle.svg", "Thunderlane.svg", "Trenderhoof.svg", "Trixie.svg", "Trouble Shoes.svg", "Twilight Sparkle.svg", "Zecora.svg" ];
  function shuffle(o){
      for(var j, x, i = o.length; i; j = GetRandNum(0, i), x = o[--i], o[i] = o[j], o[j] = x);
      return o;
  };
  function genPonyList() {
    var list = [];
    for(var i = 1; i < PonyList.length; ++i) {
      list.push(i);
    }
    shuffle(list);
    list.unshift(0);
    return list;
  }
  
  var Game = CreateGame();
  var curMouseX=0;
  var curMouseY=0;
  
  function UpdateMuffins() {
    stat_muffins.innerHTML = PrettyNum(Game.muffins);
    stat_achievementmuffins.innerHTML = PrettyNum(Game.achievement_muffins);
  }
  function ResetGame() {
    var muffins = Math.floor(inv_triangular(Game.totalsmiles/1000000000000))-1;
    //Game.muffins += muffins;
    //ShowNotice("Game reset", ((muffins==0)?null:"You get <b>" + Pluralize(muffins, " muffin") + "</b> for your <b>" + Pluralize(Game.totalsmiles, " smile") + "</b>"), null);
    ShowNotice("Reiniciar Juego", "El Prestigio de Muffins ha sido temporalmente desactivado, ¡lo sentimos!");
    Game.store = [1,0,0,0,0,0,0,0,0,0,0,0,0];
    Game.upgrades = [];
    Game.upgradeHash = {};
    Game.smiles = 0;
    Game.totalsmiles = 0;
    Game.SPC = 1;
    Game.SPS = 0;
    Game.clicks = 0;
    SaveGame();
    InitializeGame(); 
  }
  function WipeAllData() { localStorage.removeItem('game'); Game = CreateGame(); InitializeGame(); }
  function ParseGame(src) {
    var g = JSON.parse(src);
    switch(g.version)
    {
      case 3:
        Game = g;
        break;
      default:
        alert('¡Versión desconocida! El juego no ha cargado.');
    }
  }
  function ImportGame(src) { 
    ParseGame(src);
    InitializeGame();
    EarnAchievement(202);
  }
  function InitializeGame() {
    UpdateOverlay(-1,0);
    Earn(0);
    UpdateSPS();
    OrganizePonies();
    ApplySettings();
    UpdateNews();
    updateUpgradesAchievements();
  }
  function LoadGame() { 
    if(localStorage.getItem('game')!==null) { ParseGame(localStorage.getItem('game')); } 
    ApplySettings(); 
  }
  
  function ExportGame() { return JSON.stringify(Game); }
  function SaveGame() { localStorage.setItem('game', ExportGame()); ShowNotice("Juego guardado", null, null); }
  function ApplySettings() {
    document.getElementById('EnableEffects').checked = Game.settings.useCanvas;
    document.getElementById('EnableFocus').checked = Game.settings.optimizeFocus;
    document.getElementById('EnableWarn').checked = Game.settings.closingWarn;
  }
  function GetSettings() {
    Game.settings.useCanvas = document.getElementById('EnableEffects').checked;
    Game.settings.optimizeFocus = document.getElementById('EnableFocus').checked;
    Game.settings.closingWarn = document.getElementById('EnableWarn').checked;
  }
  
  LoadGame();
    
  var Store = [
    {cost:0,count:1,name:"Poni", plural: "ponis", desc: "Un poni. Los ponis necesitan amistades para generar sonrisas."}, 
    {cost:0,count:0,name:"Amistad", plural: "amistades", desc: "Una amistad entre dos ponis. ¡No podrás comprar una amistad si todos tus ponis ya son amigos!", formula: "Cada amistad genera 1 sonrisa por segundo"}, 
    {cost:0,count:0,name:"Recital", plural: "recitales", desc: "Un pequeño recital para ponis que conozcas.", formula: "Genera una sonrisa por poni.<i>SPS = P</i>"}, // P
    {cost:0,count:0,name:"Fiesta", plural: "fiestas", desc: "¡Una fiesta para todos tus amigos!", formula: "Genera una sonrisa por amistad.<i>SPS = F</i>"}, // F
    {cost:0,count:0,name:"Desfile", plural: "desfiles", desc: "¡Un gran desfile para todos los ponis y sus amigos!", formula: "Genera dos sonrisas por cada amistad y poni.<i>SPS = 2&times;(P&plus;F)</i>"}, // (P+F)*2.0
    {cost:0,count:0,name:"Concierto", plural: "conciertos", desc: "¡Un concierto para toda la ciudad!", formula: "Genera una sonrisa por cada poni, amistad, y edificio que tengas.<i>SPS = P&plus;F&plus;B</i>"}, // P+F+B
    {cost:0,count:0,name:"Festival", plural: "festivales", desc: "¡Un festival que dura una semana", formula: "Generates one smile for every pony you have, times the number of friends you have, times 1&frac12;.<i>SPS = P&times;F&times1.5</i>"}, // P*F*1.5
    {cost:0,count:0,name:"Gran Fiesta", plural: "gran fiestas", desc: "¡Una gran fiesta en Canterlot!", formula: "Generates one smile for every pony you have, times the number of friendships and buildings you have.<i>SPS = P&times;(F&plus;B)</i>"}, // P*(F+B)
    {cost:0,count:0,name:"Gran Gala del Galope", plural: "gran galas del galope", desc: "¡Celebra la Gran Gala del Galope con ponis de toda Equestria!", formula: "Generates one smile for every pony you have, times the number of friendships you have, times the number of buildings you have.<i>SPS = P&times;F&times;B</i>"}, //P*F*(B+1)
    {cost:0,count:0,name:"Coronación", plural: "coronaciones", desc: "¡Haz a un poni cualquiera una princesa solo por la fiesta!", formula: "Generates one smile per friendship, times two for every pony you have, plus the number of buildings you have.<i>SPS = 2<sup>P</sup>&times;F&plus;B</i>"}, //2^P*F+B
    {cost:0,count:0,name:"Festejo Nacional", plural: "festejos nacionales", desc: "¡Declara un festejo nacional para que todos los ponis festejen en vez de ser productivos!", formula: "Generates one smile per friendship, times the number of buildings you have, times two for every pony you have.<i>2<sup>P</sup>&times;F&times;B</i>"}, //2^P*F*(B+1)
    {cost:0,count:0,name:"Elementos de la Armonía", plural: "Elementos de la Armonía", desc: "¡Usa un gigante rayo arcoiris de la amistad para resolver todos tus problemas!", formula: "Generates a bajillion smiles for every pony you have, plus one smile per friendship times the number of buildings you own.<i>P!&div;(P-5)! &plus; F&times;B</i>"}, //P!/(P-5)! + F*B
    //{cost:0,count:1,name:"DEBUGMOUSE", plural:"DEBUGMOUSES", desc: "DEBUG DO NOT USE"}
  ];
  
  function factorial(n) { var r = n; while(--n > 1) { r = r*n; } return r; }
  function factorial_limit(n,k) { var r = n; while(--n > k) { r = r*n; } return r; }
  function max_binomial(n) { var n2=Math.floor(n/2); var r = n; while(--n > n2) { r = r*n; } return Math.floor(r/factorial(n2)); }
  
  var number_names = [
   "millones",
   "mil millones",
   "billones",
   "cuatrillón",
   "trillones",
   "trillones",
   "septillion",
   "octillion",
   "nonillion",
   "decillion",
   "undecillones",
   "duodecillones",
   "tredecillion",
   "quattuordecillion", // Este nombre es tan largo que se rompe el formato en lugares: C
   "quindecillion",
   "sexdecillion",
   "septendecillion",
   "octodecillion",
   "novendecillion",
   "vigintillion",
   "centillion"];
  
  function GetRandNum(min, max) { // Random number in the range [low, high) 
    return Math.floor(Math.random()*(max-min))+min;
  }
  
  function GetNews() {
    var news = [];
    
    // These are specific smile count related messages
    if(Game.totalsmiles < 30) {
      news.push(
        "Ponyville en ruinas, informa transeúnte anónimo.",
        "Ponyville informa clara falta de sonrisas.",
        "Pronóstico de sonrisas para hoy: Depresión con un toque de desesperación.",
        "Ponyville en necesidad desesperada de emoción.",
        "Los antidepresivos se venden en todo Ponyville.",
        "La Alcaldesa Mare pregunta por qué todos se sienten tan mal, informa que no se molestará en averiguarlo."
      );
    } else if(Game.totalsmiles < 1000) {
      news.push("¡Los ciudadanos de Ponyville se preguntan qué es esta extraña y nueva sensación! Los científicos la llaman 'sonreír', teóricos conspirantes lo denuncian como una estratagema para dominar el mundo.",
        "¡Ponis malhumorados cada vez mas fuera de lugar en la nueva Ponyville!",
        "¡Se han visto ponis pequeños jugando en las calles! Padres inseguros si la llamada 'diversión' debería estar permitida.",
        "Mercaderes proponen vender 'bienes económicos' en vez de 'okays económicos'. Los clientes están alerta por estafas de marketing.");
    } else if(Game.totalsmiles < 1000000) {
      news.push("¡Los ponis se saludan con sonrisas en sus rostros! ¡Ponis viejos y irritables lo critican!",
        "Iron Will ahora enseña asertividad en vez de métodos para hacer frente a la depresión.",
        "¡Varios ponis jóvenes vistos chocando sus cascos! ¡Padres preocupados por la nueva moda!",
        "Terapeuta molesto por creciente felicidad en ponis, dice que es malo para el negocio.");
    } else if(Game.totalsmiles < 1000000000) {
      news.push("¡Canciones ahora suenan espontáneamente en Ponyville!",
      "¡Ponyville elegida como la ciudad más feliz de Equestria!",
      "¡Ponis de todos lados vienen a visitar Ponyville!");
    } else if(Game.totalsmiles < 1000000000000) {
      news.push(
        "¡Princesa Twilight encontrada con sobredosis de amistad, llevada al centro de rehabilitación!",
        "¡Los ciudadanos de Ponyville están tan felices que inventaron una nueva palabra para ello! ¡Debates sobre como se escribe llevan inmediatamente a disturbios homicidas!");
    } else if(Game.totalsmiles < 1000000000000000) {
      news.push("¡Los ciudadanos de Ponyville sufren de felicidad crónica! ¡Médicos dudan si en realidad es un problema o no!");
    } else if(Game.totalsmiles < 1000000000000000000) {
      news.push("¡Los científicos dividieron la amistad y descubren una reacción en cadena! ¡Bomba nuclear de amistad propuesta por militares!");
    } else {
      news.push("¡Nuevo sistema de la física sugiere toda la materia en el universo esta compuesta de diferentes tipos de sonrisas!");
    }
    
    // After 10000 smiles we start putting in most of the standard news messages into rotation.
    if(Game.totalsmiles > 10000) {
      news.push(
        '¡Twilight encuentra shipping de Rainbow Dash con todo en el universo! ¡Disturbios en toda Equestria!',
        '¡Lyra y BonBon son "solo amigas"! ¡Ponis de todos lados entran en shock!',
        "¡Deseo insaciable por pastel de Celestia causa pastelástrofe en la cocina Real! Una ceremonia en memoria de los chips de chocolate perdidos se celebrará el lunes.",
        "¡Amenaza rosada en el Sugarcube corner toma por rehenes a 15 muffins!",
        "¡Ciudadanos de Ponyville votan para crear una biblioteca pública en lugar de confiar en una colección privada organizada por una yegua púrpura enloquecida!",
        "Pequeño potro encuentra granero Apple flotando en el espacio. Rainbow Dash declara no tener idea de cómo llegó eso allí.",
        "Rarity se une a los ambientalistas, declara que ya no irá al spa. El spa de Ponyville va inmediatamente a la quiebra.",
        "A raíz de un incidente de sodio mal etiquetado y un baño que explota, Celestia ordena a Sweetie Bot que se registre como arma letal.",
        "Según informes, Rainbow Dash invierte repetidamente en la Nube. Pegasos de todo el mundo confundidos.",
        "¡La Princesa Twilight descubre que los ponis son en realidad reactores nucleares pequeños! \"Eso explica por qué nunca tengo que ir al baño,\" dice Rainbow Dash.",
        "¡Poni poni poni poni poni poni!",
        "¡La Princess Twilight Sparkle está saliendo con un melocotón! El melocotón no tiene ningún comentario sobre el asunto."
      );
      
      if(Game.muffins > 10) {
        news.push(
          'When asked how she saved the bakery from certain disaster, Derpy Hooves claims there was "Muffin to it!"',
          "Try new smile-powered Muffins today!",
          'Mayor held hostage by crazed Doctor, who demands that a muffin factory be built "for the sake of all ponykind!"',
          'Derpy and Troubleshoes get married! Ponyville does not survive the wedding.',
          'Scientists investigate whether excessive muffin consumption can lead to long, overbearing plots.'
        );
      }
      if(Game.muffins > 100) {
        news.push('Derpy crashes into giant muffin. Irony is not amused.');
      }
    }
    
    return news[GetRandNum(0, news.length)];
  }
  var newsnum = 0;
  var newswait = 15000;
  var lastNews;
  function UpdateNews() {
    var n1 = newsnum;
    newsnum = (newsnum + 1) % 2;
    var n2 = newsnum;
    document.getElementById('news' + n1).className = '';
    document.getElementById('news' + n2).className = 'inactive';
    document.getElementById('news' + n1).innerHTML = "Noticias: " + GetNews();
  }
  function PrettyNum(x) {
    var d = Math.floor(Math.log10(x));
    if(d<6) return x.toFixed(0);
    x = Math.floor(x/Math.pow(10,d-(d%3)-3));
    var n = Math.floor((d-3)/3) - 1;
    if(n >= number_names.length) return "Infinidad";
    return (x/1000) + " " + number_names[n];
  }
  function Pluralize(n, s) { return PrettyNum(n) + s + ((n==1)?'':'s'); }
  
  function basic_upgrade(sps, item, p, m) { sps[item] = (sps[item]+p)*(m+1); return sps; }
  function global_upgrade(sps, p, m) { for(var i = 0; i < sps.length; ++i) { sps[i] = (sps[i]+p)*(m+1); } return sps; }
  function gen_upgradetype1(item, pSPS, mSPS) { return function(sps, store) { var c = store[item]; return basic_upgrade(sps, item, pSPS*c, mSPS*c); } }
  function gen_upgradetype2(sps, count, pSPS, mSPS) { Game.SPC+=(pSPS*count); Game.SPC*=(1+mSPS); return sps; }
  function gen_muffinupgrade(pSPS, mSPS) { return function(sps, store) { return global_upgrade(sps, pSPS, mSPS*Game.muffins); } }
  function gen_totalsps(sps, store) { var total = 0; for(var i = 0; i < sps.length; ++i) { total += sps[i]*store[i]; } return total; }
  
  var upgradeList = [ {cost:0, name:"UNDEFINED", desc:"ERROR", fn:null},
    {cost:700, name:"Asistente de Clicks", desc: "Clicking gets +1 SPC for every pony you have.", fn:function(sps,store){return gen_upgradetype2(sps, store[0], 1, 0);} },
    {cost:7000, name:"Los Clicks de la Amistad", desc: "Clicking gets +1 SPC for every friendship you have.", fn:function(sps,store){return gen_upgradetype2(sps, store[1], 1, 0);} },
    {cost:70000, name:"Cosquillacursores", desc: "Clicking gets 1% of your SPS.", fn:function(sps,store){return gen_upgradetype2(sps, gen_totalsps(sps, store), 0.01, 0); }},
    {cost:700000, name:"Cursores Emplumados", desc: "Clicking gets 2% of your SPS.", fn:function(sps,store){return gen_upgradetype2(sps, gen_totalsps(sps, store), 0.02, 0); }},
    {cost:8000000, name:"Cosqui-fu Avanzado", desc: "Clicking gets 3% of your SPS.", fn:function(sps,store){return gen_upgradetype2(sps, gen_totalsps(sps, store), 0.03, 0); }},
    {cost:90000000, name:"Inyección de Felicidad", desc: "Clicking gets 4% of your SPS.", fn:function(sps,store){return gen_upgradetype2(sps, gen_totalsps(sps, store), 0.04, 0); }},
    {cost:10000, name:"La Magia de la Amistad", desc: "Friendships generate +1 SPS for every other friendship.", fn:gen_upgradetype1(1, 1, 0) },
    {cost:1000000, name:"Los Conjuros de la Amistad", desc: "Friendships generate +10 SPS for every other friendship.", fn:gen_upgradetype1(1, 10, 0) },
    {cost:100000000, name:"La Brujería de la Amistad", desc: "Friendships generate +100 SPS for every other friendship.", fn:gen_upgradetype1(1, 100, 0) },
    {cost:10000000000, name:"La Amistad es Brujería Sobrenatural", desc: "Friendships generate +1000 SPS for every other friendship.", fn:gen_upgradetype1(1, 1000, 0) },
    {cost:1000000000000, name:"La Amistad con Beneficios", desc: "Friendships generate +10000 SPS for every other friendship.", fn:gen_upgradetype1(1, 10000, 0) },
    {cost:7777777, name:"¡Yo no se qué salió mal!", desc: "You gain +0.1% SPS for every muffin you have.", fn:gen_muffinupgrade(0, 0.001) },
    {cost:777777777, name:"Esa Poni Cartera", desc: "You gain +0.2% SPS for every muffin you have.", fn:gen_muffinupgrade(0, 0.002) },
    {cost:77777777777, name:"Servicio de Entrega de Derpy", desc: "You gain +0.3% SPS for every muffin you have.", fn:gen_muffinupgrade(0, 0.003) },
    {cost:7777777777777, name:"Muffins de Arándano", desc: "You gain +0.4% SPS for every muffin you have.", fn:gen_muffinupgrade(0, 0.004) },
    {cost:777777777777777, name:"Muffins con Chips de Chocolate", desc: "You gain +0.5% SPS for every muffin you have.", fn:gen_muffinupgrade(0, 0.005) },
    {cost:77777777777777777, name:"Muffins de Limón", desc: "You gain +0.6% SPS for every muffin you have.", fn:gen_muffinupgrade(0, 0.006) },
    {cost:7777777777777777777, name:"Muffins con Semillas de Amapola", desc: "You gain +0.7% SPS for every muffin you have.", fn:gen_muffinupgrade(0, 0.007) },
    {cost:777777777777777777777, name:"Panaderías de Muffins", desc: "You gain +0.8% SPS for every muffin you have.", fn:gen_muffinupgrade(0, 0.008) },
    {cost:77777777777777777777777, name:"Muffins de Diseñador", desc: "You gain +0.9% SPS for every muffin you have.", fn:gen_muffinupgrade(0, 0.009) },
    {cost:7777777777777777777777777, name:"Fábrica de Muffins", desc: "You gain +1% SPS for every muffin you have.", fn:gen_muffinupgrade(0, 0.01) },
    //{cost:50000, name:"Upgrade 3", desc: "Parties generate +1 SPS for every other party.", fn:gen_upgradetype1(2, 1, 0) }
  ];
  
  for(var i = 0; i < upgradeList.length; ++i) {
    upgradeList[i].id = i;
  }
  document.getElementById('upgrades_total').innerHTML = (upgradeList.length-1).toFixed(0); //-1 for the error one at 0
  
  curUpgradeList = [];
  
  var achievementList = {
    '1': { name:"Premio a la Participación", desc: "¡Has movido el ratón!", muffins:0},
    '2': { name:"¡Hola hola!", desc: "Clickea un poni <b>una vez</b>.", muffins:0, cond:function(){ return Game.clicks > 0; } }, 
    '200': { name:"Prudente", desc: "Guarda el juego manualmente.", muffins:1},
    '201': { name:"Paranoico", desc: "Exporta un archivo de guardado.", muffins:1},
    '202': { name:"Máquina del Tiempo", desc: "Importa un archivo de guardado.", muffins:1},
    '203': { name:"¡Narcisismo!", desc: "Clickea en la imagen de Cloud Hop en la página de créditos.", muffins:1},
    '204': { name:"La Música lo hace todo mejor", desc: "Escucha la Canción de la Sonrisa.", muffins:1},
    '205': { name:"Monstruo", desc: "Vende una amistad.", muffins:1},
    '255': { name:"Perfeccionista", desc: "Consigue todos los logros.", muffins:100}
  };
  
  function genAchievements(names, amounts, descgen, condgen) {
    var ids = [];
    
    if(names.length != amounts.length) { alert("ERROR: names != amounts"); }
    for(var i = 0; i < names.length; ++i) {
      ids.push(achievementCount);
      achievementList[achievementCount++] = { name:names[i], desc: descgen(amounts[i]), muffins:(i+1), cond:condgen(amounts[i]) };
    }
    
    return ids;
  }
  
  var achievementCount = 3;
  var achievements_clicks = genAchievements(
    ["¡Cosquillas!", "Guerra de Cosquillas", "Guerra de Cosquillas II: El Recosquilleo", "Esto No Puede Ser Saludable", "Síndrome del Túnel Carpiano", "Muerte de Muñeca", "Clickception"],
    [10,100,1000,10000,100000,1000000,10000000],
    function(n) { return "Click a pony <b>"+PrettyNum(n)+"</b> times."; },
    function(n) { return function() { return Game.clicks >= n; }; });
  achievements_clicks.push(2);
    
  var achievements_smiles = genAchievements(
    ["Risa", "Alegría", "Felicidad", "Nirvana", "Éxtasis", "Búsqueda de la Felicidad", "Ya no Podrás Parar", "Esto es Ridículo", "Ve a Leer un Libro", "¡¿Cómo?!"],
    [100,10000,1000000,100000000,10000000000,1000000000000,100000000000000,10000000000000000,1000000000000000000,100000000000000000000],
    function(n) { return "Get <b>"+PrettyNum(n)+"</b> smiles."; },
    function(n) { return function() { return Game.totalsmiles >= n; }; });
    
  function genShopCond(item) {
    return function(n) { return function() { return Game.store[item]>=n; }; };
  }
  
  var achievements_shop = [];
  function genShopAchievements(item, names) {
    return genAchievements(
    names,
    [1, 50, 100, 200, 300],
    function(n) { return "Comprar <b>"+Pluralize(n, "</b> " + Store[item].name.toLowerCase()) + "."; },
    genShopCond(item));
  }
  
  achievements_shop = achievements_shop.concat(genShopAchievements(2, ["Aficionado", "Músico de Calle", "Artista", "Multi-instrumentista", "Conductor"]));
  achievements_shop = achievements_shop.concat(genShopAchievements(3, ["Extrovertido", "Sociable", "Cañon de Fiesta", "Alma de la Fiesta", "Pinkie Pie"]));
  achievements_shop = achievements_shop.concat(genShopAchievements(4, ["Flotador Asistente", "Rainbow Dash Gigante Flotante", "Demasiado Conffetti", "Atracción Principal", "Alcaldesa Mare"]));
  achievements_shop = achievements_shop.concat(genShopAchievements(5, ["Solo de Piano", "Cuarteto de Cuerdas", "Coro de Cámara", "Orquesta de 70 Piezas", "Octavia"]));
  achievements_shop = achievements_shop.concat(genShopAchievements(6, ["Celebración del Sol de Verano", "Carrera de las Hojas", "Envolviendo el Invierno", "Noche de los Corazones Cálidos", "Consagración de la Primavera"]));
  achievements_shop = achievements_shop.concat(genShopAchievements(7, ["Entusiasta", "Muevecabeza", "¡Luces Químicas Para Todos!", "Bass Pumper", "DJ Pon3"]));
  achievements_shop = achievements_shop.concat(genShopAchievements(8, ["La Mejor Noche", "Aristocracia", "Baile en el Salón", "¡TODOS VAN A QUERERME!", "Realmente Aburrido"]));
  achievements_shop = achievements_shop.concat(genShopAchievements(9, ["Princesa Twilight", "Príncipe Shining Armor", "Princesa Big Mac", "Princesa Derpy", "¡Todopony es Princesa!"]));
  achievements_shop = achievements_shop.concat(genShopAchievements(10, ["Noche de Nightmare", "Día de la Madre", "Día del Padre", "Día de Rainbow Dash es Asombrosa", "Día del Trasero"]));
  achievements_shop = achievements_shop.concat(genAchievements(
    ["Lealtad", "Por Tus Poderes Combinados", "Honestidad", "Risa", "Generosidad", "Amabilidad"],
    [1, 6, 50, 100, 200, 300],
    function(n) { return "Comprar <b>"+Pluralize(n, "</b> " + Store[11].name.toLowerCase()) + "."; },
    genShopCond(11)));
    
  achievementCount += 7; // for our special ones at the end
  document.getElementById('achievements_total').innerHTML = achievementCount.toFixed(0);
  
  var score = document.getElementById("scorenum");
  var store = document.getElementById("store");
  var stat_cursmiles = document.getElementById('stat_cursmiles');
  var stat_totalsmiles = document.getElementById('stat_totalsmiles');
  var stat_SPS = document.getElementById('stat_SPS');
  var stat_clicks = document.getElementById('stat_clicks');
  var stat_SPC = document.getElementById('stat_SPC');
  var stat_buildings = document.getElementById('stat_buildings');
  var stat_time = document.getElementById('stat_time');
  var stat_muffins = document.getElementById('stat_muffins');
  var stat_achievementmuffins = document.getElementById('stat_achievementmuffins');
  var achievements_owned = document.getElementById('achievements_owned');
  var upgrades_owned = document.getElementById('upgrades_owned');
  var ponywrapper = document.getElementById('ponywrapper');
  var smilethumb = '<img src="pinkiehappy.png" alt="Smiles: " title="Smiles" />';
  var canvas = document.getElementById("canvas");
  var ctx = canvas?canvas.getContext("2d"):null;
  var canvaslines = document.getElementById("canvaslines");
  var ctxlines = canvaslines.getContext("2d");

  function dynFontSize(str) {
    var size=80;
    if(str.length < 21) {
      size=100;
    } else if(str.length < 31) {
      size=90;
    }
    return '<span style="font-size:'+size+'%;">'+str+'</span>';
  }
  function updateUpgradesAchievements() {
    achievements_owned.innerHTML = Game.achievementcount.toFixed(0);
    upgrades_owned.innerHTML = Game.upgrades.length.toFixed(0);
    var html = '';
    
    var count = 0;
    for (var prop in achievementList) {
        if (achievementList.hasOwnProperty(prop)) {
          html += '<div class="achievement '+(Game.achievements[prop]===undefined?'hidden':'')+'" style="background: #000 url(\'./achievements.png\');"><div class="menutooltip" style="left: '+(-2-((count%5)*54))+'px;"><strong>'+dynFontSize(achievementList[prop].name)+'</strong><i>[achievement]</i><hr/><p>'+achievementList[prop].desc+'</p></div></div>';
        }
        count++;
    }    
    document.getElementById('achievements').innerHTML = html;
    
    html = '';
    for(var i = 0; i < Game.upgrades.length; ++i) { // TODO: Make unique upgrade images
      html += '<div class="achievement" style="background: #000 url(\'./upgrades.png\');"><div class="menutooltip" style="left: '+(-2-((i%5)*54))+'px;"><strong>'+dynFontSize(upgradeList[Game.upgrades[i]].name)+'</strong><i>[upgrade]</i><hr/><p>'+upgradeList[Game.upgrades[i]].desc+'</p></div></div>';
    }
    
    document.getElementById('upgradelist').innerHTML = html;
    UpdateMuffins();
  }
  
  function ResizeCanvas() {
    canvas.width  = document.getElementById('ponybg').offsetWidth;
    canvas.height = document.getElementById('ponyboard').offsetHeight;
  }
  
  // Generate store HTML
  var storehtml = '';
  for(var i = 0; i < Store.length; ++i) {
    var ponyreq = (i!=1)?'':'<span id="ponycost">(2 PONIES)</span>';
    storehtml += '<li class="disable" id="buy' + i + '" onclick="if(this.className != \'disable\') { Buy(' + i + ') } else { ShowMouseText(\'Too expensive!\',0,-40); }" oncontextmenu="Sell(' + i + '); return false;">' + Store[i].name.toLowerCase() + '<br/><span class="cost">'+smilethumb+'<span id="cost' + i + '">0</span></span>' + ponyreq + '<span class="count" id="count' + i + '">0</span></li>';
  }
  store.innerHTML += storehtml;
  
  function Click(id) {
      var amount = Math.floor(Game.SPC);
      Earn(amount);
      Game.clicks += 1;
      stat_clicks.innerHTML = PrettyNum(Game.clicks);
      ShowMouseText('+' + PrettyNum(amount), 2, -40);
      CheckAchievements(achievements_clicks);
  }
  function triangular(n) {
    return (n*(n-1))/2; // number of edges in a complete graph of n nodes
  }
  function inv_triangular(n) {
    return 0.5*(Math.sqrt(8*n + 1) + 1); // Returns the triangular number that would produce this many edges
  }
  function fbnext(x) {
    return x + 1 + (x>>1) + (x>>3) - (x>>7) + (x>>10) - (x>>13);
  }
  
  // The game's difficulty is modelled using a series of curves defined by these values
  function fn_ratio(init,curve) { return function(n) { return init*Math.pow(curve,n); }; }
  var fcurve = 1.3; // Friendship curve
  var fcurve_init = 20;
  var rcurve = 1.13; // cost ratio curve
  var rcurve_init = 32; // Initial cost ratio (for a party)
  var fn_rratio = fn_ratio(rcurve_init,rcurve); // gets the SPS ratio for a store of level n
  
  // The fundamental curve is the cost of friendships. This forms a simple recurrence relation f_n = a*f_n-1, which has a closed-form solution of f_n = f_0*a^n
  var fn_cost1 = fn_ratio(fcurve_init, fcurve);
  Store[1].initcost = fcurve_init;
  Store[1].costcurve = fcurve;
  
  // The cost of ponies is based on the cost of buying k+1 friendships, where k is the number of edges in a complete graph of n-nodes, which is just a triangular number. So, we take the current number of ponies, find the corresponding triangular number, add one and plug that into the friendship cost function.
  var fn_cost0 = function(n) { return (n<2)?15:fn_cost1(triangular(n)+1); };
  
  function default_cost(i, n) { return Store[i].initcost*Math.pow(Store[i].costcurve,n); };
  function inv_cost(i, cost) { return Math.floor(Math.log(cost/Store[i].initcost)/Math.log(Store[i].costcurve)); }
  
  Store[0].fn_SPS = function(P,F,B) { return 0; };
  Store[1].fn_SPS = function(P,F,B) { return 1.0; };
  Store[2].fn_SPS = function(P,F,B) { return P; };
  Store[3].fn_SPS = function(P,F,B) { return F; };
  Store[4].fn_SPS = function(P,F,B) { return (P+F)*2.0; };
  Store[5].fn_SPS = function(P,F,B) { return (P+F+B); };
  Store[6].fn_SPS = function(P,F,B) { return (P*F)*1.5; };
  Store[7].fn_SPS = function(P,F,B) { return (P*(F+B)); };
  Store[8].fn_SPS = function(P,F,B) { return (P*F*(B+1)); };
  Store[9].fn_SPS = function(P,F,B) { return Math.pow(2, P)*F+B; };
  Store[10].fn_SPS = function(P,F,B) { return Math.pow(2, P)*F*(B+1); };
  Store[11].fn_SPS = function(P,F,B) { return factorial_limit(P,5)+(F*B); };
  //Store[12].fn_SPS = function(P,F,B) { return 0; };
  
  // A store's initial cost is based on the number of friendships you (should) have already bought, or can currently afford, which is then used to calculate how many of everything else you have to generate a SPS and then apply the relevant SPS ratio to derive the appropriate cost
  
  function initSPS(f,r,b) { return Store[r].fn_SPS(Math.floor(inv_triangular(f)),f,b); }
  function initcost(f,r,b) { return initSPS(f,r,b)*fn_rratio(r-2); }
  
  function fn_estimatebuildings(cost, max) {
    var b = 0;
    for(var j = 2; j < max; ++j) {
      b += inv_cost(j, cost);
    }
    return b;
  }
  // Return a curve that results in a cost equal to the new SPS ratio after n buildings are bought.
  /*function fn_costcurve(n,ratio,i,cost) {
    // x is the new cost
    // x = initSPS(inv_cost(1, x), i, fn_estimatebuildings(x, i))*ratio
    // Instead of trying to solve that for x, we just estimate the building count increase. 
    // x = initSPS(inv_cost(1, x), i, fn_estimatebuildings(cost, i)+n*i)*ratio
    var b = fn_estimatebuildings(cost, i)+n*i;
    // We can't solve for x because we'd have to solve for x for every single individual building, so we do an iterative solve using cost as an initial guess.
    var x = cost;
    for(var j = 0; j < 1; ++j) {
      x = initSPS(inv_cost(1, x), i, b)*ratio;
    }
    return Math.pow(x/cost, 1.0/n);
  }*/
  
  var Fvals = [4,12,30,35,45,45,45,51,51,100];
  
  for(var i = 2; i < 12; ++i) {
    var cost = fn_cost1(Fvals[i-2]);
    var b = fn_estimatebuildings(cost, i);
    Store[i].initcost = initcost(Fvals[i-2],i,b);
    Store[i].costcurve = 1.2 + (i*i*0.0045); //fn_costcurve(5, fn_rratio(i-2)*1.5, i, Store[i].initcost);
  }  
  
  Store[0].cost = fn_cost0;
  Store[1].cost = fn_cost1;
  Store[2].cost = function(n) { return default_cost(2, n); };
  Store[3].cost = function(n) { return default_cost(3, n); }; 
  Store[4].cost = function(n) { return default_cost(4, n); }; 
  Store[5].cost = function(n) { return default_cost(5, n); }; 
  Store[6].cost = function(n) { return default_cost(6, n); }; 
  Store[7].cost = function(n) { return default_cost(7, n); }; 
  Store[8].cost = function(n) { return default_cost(8, n); }; 
  Store[9].cost = function(n) { return default_cost(9, n); }; 
  Store[10].cost = function(n) { return default_cost(10, n); }; 
  Store[11].cost = function(n) { return default_cost(11, n); };
  //Store[12].cost = function(n) { return 1; };
  
  function Earn(num) {
    if(num>0) { Game.totalsmiles += num; }
    Game.smiles += num;
    score.innerHTML = Pluralize(Game.smiles, " smile");
    stat_cursmiles.innerHTML = PrettyNum(Game.smiles);
    stat_totalsmiles.innerHTML = PrettyNum(Game.totalsmiles);
    UpdateStore();
    CheckAchievements(achievements_smiles);
  }
  function EarnAchievement(id) {
    if(Game.achievements[id] === undefined) {
      Game.achievements[id] = achievementList[id].muffins;
      Game.achievementcount++;
      ShowNotice(achievementList[id].name, achievementList[id].desc, "achievement");
      Game.muffins += achievementList[id].muffins;
      Game.achievement_muffins += achievementList[id].muffins;
      updateUpgradesAchievements();
      if(Game.achievementcount >= (achievementCount-1)) {
        EarnAchievement(255);
      }
    }
  }
  function CheckAchievements(list) {
    for(var i = 0; i < list.length; ++i) {
      if(achievementList[list[i]].cond()) {
        EarnAchievement(list[i]);
      }
    }
  }
  var lastUpgradeHTML = '';
  function UpdateStore() {
    var ponycost = document.getElementById("ponycost");
    ponycost.innerHTML = "(NEEDS " + Math.ceil(inv_triangular(Game.store[1]+1)) + " PONIES)";
    ponycost.style.display = 'none';
    for(var i = 0; i < Store.length; ++i) { 
      var item = Store[i];
      var count = Game.store[i];
      var cost = item.cost(count);
      if(i == 1 && count >= triangular(Game.store[0])) {
        document.getElementById("buy" + i).className = "disable";
        ponycost.style.display = 'inline';
      } else {
        document.getElementById("buy" + i).className = (cost>Game.smiles)?"disable":"";
      }
      document.getElementById("cost" + i).innerHTML = PrettyNum(cost);
      document.getElementById("count" + i).innerHTML = count;
    }
    
    var html = '';
    curUpgradeList = [];
    for(var i = 1; i < upgradeList.length; ++i) { // start at one to skip UNDEFINED upgrade
      if(upgradeList[i].cost < (Game.totalsmiles*0.8) && Game.upgradeHash[i] === undefined) {
        curUpgradeList.push(i);
        html += '<div class="achievement'+((upgradeList[i].cost>Game.smiles)?' hidden':'')+'" onclick="BuyUpgrade('+i+');" style="background: #000 url(\'./upgrades.png\');"></div>';
      }
    }
    if(lastUpgradeHTML != html) {
      document.getElementById('storeupgrades').innerHTML = html;
      lastUpgradeHTML = html;
    }
  }
  function CountBuildings(store) {
    var count = 0;
    for(var i = 2; i < store.length; ++i) {
      count += store[i];
    }
    return count;
  }
  // Seperating this out lets us make predictions on what a purchase will do to your SPS
  function CalcSPS(store, docache) {
    var res = CalcSPSinit(store);
    var SPC = Game.SPC;
    
    Game.SPC = 1;
    for(var i = 0; i < Game.upgrades.length; ++i) {
      res = upgradeList[Game.upgrades[i]].fn(res, store);
      if(!res || !res.length) {
        alert("ILLEGAL UPGRADE: " + Game.upgrades[i]);
      }
    }
    stat_SPC.innerHTML = PrettyNum(Game.SPC);
    
    if(!docache) { Game.SPC = SPC; } // HACK to fix SPC exploit
    
    var SPS = 0;
    for(var i = 0; i < res.length; ++i) {
      if(docache) { Store[i].SPS_cache = res[i]*store[i]; }
      SPS += res[i]*store[i];
    }
    return SPS;
  }
  function CalcSPSinit(store) {
    var P = store[0];
    var F = store[1];
    var B = CountBuildings(store);
    var result = [];
    for(var i = 0; i < Store.length; ++i) {
      result.push(Store[i].fn_SPS(P,F,B));
    }
    return result;
  }
  function UpdateSPS() {
    Game.SPS = CalcSPS(Game.store, true);
    var s = document.getElementById("SPS");
    if(Game.SPS > 0) {
      s.style.display = "block";
      s.innerHTML = "+" + ((Game.SPS<=999)?Game.SPS.toFixed(1):PrettyNum(Game.SPS)) + " per second";
    } else {
      s.style.display = "none";
    }
    
    stat_SPS.innerHTML = PrettyNum(Game.SPS);
  }
  function displayTime(milliseconds) {
    var seconds = Math.floor(milliseconds/1000)%60;
    var minutes = Math.floor(milliseconds/60000)%60;
    return Math.floor(milliseconds/3600000).toFixed(0) + ':' + (minutes<10?'0':'') +  minutes.toFixed(0) + ':' + (seconds<10?'0':'') + seconds.toFixed(0);
  }
  function drawImage(img, x, y, r) {
    if(r != 0) {
      ctx.translate(img.width/2, img.height/2); 
      ctx.translate(x, y);
      ctx.rotate(r); 
      ctx.drawImage(img,-img.width/2,-img.height/2);
    } else {
      ctx.drawImage(img, x, y);
    }
    ctx.restore();
  }
  
  var lastTime;
  var startTime;
  var lastTick; // Ticks are used for things like updating the total playtime
  var lastSave;
  function UpdateGame(timestamp) {
    if (!startTime) { 
      startTime = timestamp;
      lastNews = timestamp;
      lastTime = timestamp;
      lastTick = timestamp;
      lastSave = timestamp;
    }
    Game.delta = timestamp - lastTime;
    var hasFocus = !Game.settings.optimizeFocus || document.hasFocus();
    var framelength = (hasFocus?33:500); // 33 is 30 FPS
    if(Game.delta>framelength) { // play at 30 FPS or the text starts flickering
      ProcessSPS(Game.delta);
      lastTime = timestamp;
    }
    if((timestamp - lastNews)>newswait) {
      UpdateNews();
      lastNews = timestamp;
    }
    if((timestamp - lastSave)>60000) {
      SaveGame();
      lastSave = timestamp;
    }
    if((timestamp - lastTick)>500) {
      Game.totalTime += 500;
      stat_time.innerHTML = displayTime(Game.totalTime);
      UpdateOverlay(null, null);
      lastTick = timestamp;
    }
    if(Game.settings.useCanvas && (hasFocus || Game.delta>framelength)) {
      var grd = ctx.createLinearGradient(0,0,0,canvas.height);
      grd.addColorStop(0,"#d8f6ff");
      grd.addColorStop(1,"#1288e2");
      ctx.fillStyle = grd;
      ctx.fillRect(0,0,canvas.width,canvas.height);
          
      var img_rays = document.getElementById('img_rays');
      img_rays.width = 2470;
      img_rays.height = 2460;
      var img_ground = document.getElementById('img_ground');
      img_ground.width = 2051;
      img_ground.height = 560;
      ctx.save(); 
      drawImage(img_rays, canvas.width/2-img_rays.width/2, canvas.height-img_rays.height/2, ((timestamp - startTime)/3000)%(2*Math.PI));
      drawImage(img_ground, canvas.width/2-img_ground.width/2, canvas.height-img_ground.height/2, 0);     
    }
    window.requestAnimationFrame(UpdateGame);
  }
  function UpdateOverlay(item, y) {
    var overlay = document.getElementById("overlay");
    if(y != null && item >= 0) {
      overlay.style.top = Math.min(Math.max(y-40,0),window.innerHeight-overlay.offsetHeight) + 'px';
    }
    if(item == null) {
      item = overlay.getAttribute('data-item', item);
    } else if(item == overlay.getAttribute('data-item', item)) {
      return;
    }
    overlay.setAttribute('data-item', item);
    
    if(item < 0) {
      overlay.style.display = 'none';
      return;
    }
    
    var x = Store[item];
    var xcount = Game.store[item];
    var xcost = x.cost(xcount);
    var html = '<div class="title"><p>'+x.name+'</p><span>'+smilethumb+PrettyNum(xcost)+'</span>';
    if(xcount > 0) { html += '<div>['+PrettyNum(xcount)+' owned]</div>'; }
    html += '</div><hr/><p>'+x.desc+'</p><hr/><ol>';
    if(x.formula) { html += '<li>'+x.formula+'</li>'; }
    if(x.SPS_cache > 0) { html += '<li>Each '+x.name.toLowerCase()+' generates <b>'+Pluralize(x.SPS_cache, ' smile')+'</b> per second</li>'; }
    if(xcount > 0 && x.SPS_cache > 0) { html += '<li><b>'+PrettyNum(xcount)+'</b> '+x.plural.toLowerCase()+' generating <b>'+Pluralize(xcount*x.SPS_cache, ' smile')+'</b> per second</li>'; }
    var nstore = Game.store.slice();
    nstore[item]+=1;
    var nSPS = CalcSPS(nstore, false);
    
    html += '<li>Buying one '+x.name.toLowerCase()+' will increase your SPS by <b>'+PrettyNum(nSPS - Game.SPS)+'</b><i>You pay <b>'+Pluralize(xcost/(nSPS - Game.SPS), ' smile') + '</b> per +1 SPS</li></ol>';
    
    overlay.innerHTML = html;
    overlay.style.display = 'block';
  }
  function UpdateUpgradeOverlay(item, x, y) {
    var overlay = document.getElementById("upgradeoverlay");
    if(item != null && item >= curUpgradeList.length) { item = -1; }
    
    if(y != null && item >= 0) {
      overlay.style.left = x-316 + 'px';
      overlay.style.top = Math.max(y-14,0) + 'px';
    }
    if(item == null) {
      item = overlay.getAttribute('data-item', item);
    } else if(item == overlay.getAttribute('data-item', item)) {
      return;
    }
    overlay.setAttribute('data-item', item);
    
    if(item < 0) {
      overlay.style.display = 'none';
      return;
    }
    
    var x = upgradeList[curUpgradeList[item]];
    overlay.innerHTML = '<div class="title"><p>'+x.name+'</p><span>'+smilethumb+PrettyNum(x.cost)+'</span></div><hr/><p>'+x.desc+'</p>';
    overlay.style.display = 'block';
  }
  function ProcessSPS(delta) {
    Earn(Game.SPS*(delta/1000.0));
  }
  
  function Buy(id) {
    var n = Game.shiftDown?10:1;
    var numPurchase=0;
    var totalCost=0;
    for(var i = 0; i < n; ++i) {
      var cost = Store[id].cost(Game.store[id]);
      if(Game.smiles >= cost) {
        numPurchase++;
        totalCost+=cost;
        Earn(-1 * cost);
        Game.store[id] += 1;
      }
    }
    if(n>1) {
      ShowNotice(Store[id].name, "Purchased <b>" + numPurchase + " " + Store[id].plural + "</b> for <b>" + Pluralize(totalCost, " smile") + "</b>");
    }
    
    UpdateStore();
    UpdateSPS();
    UpdateOverlay(null, null);
    OrganizePonies();
    stat_buildings.innerHTML = CountBuildings(Game.store).toFixed(0);
    CheckAchievements(achievements_shop);
  }
  function Sell(id) {
    if(!id) return; // you can't sell ponies you heartless monster
    if(id == 1) { EarnAchievement(205); }
    
    var n = Game.shiftDown?10:1;
    var numSell=0;
    var totalCost=0;
    for(var i = 0; i < n; ++i) {
      if(Game.store[id]>0) {
        Game.store[id] -= 1;
        var cost = 0.5 * Store[id].cost(Game.store[id]);
        Earn(cost);
        numSell++;
        totalCost+=cost;
      }
    }
    if(n>1) {
      ShowNotice(Store[id].name, "Sold <b>" + numSell + " " + Store[id].plural + "</b> for <b>" + Pluralize(totalCost, " smile") + "</b>");
    }
    UpdateStore();
    UpdateSPS();
    UpdateOverlay(null, null);
    OrganizePonies();
    stat_buildings.innerHTML = CountBuildings(Game.store).toFixed(0);
  }
  function BuyUpgrade(id) {
    var x = upgradeList[id];
    if(Game.smiles > x.cost) {
      Earn(-1 * x.cost);
      Game.upgrades.push(id);
      Game.upgradeHash[id] = id;
    }
    
    UpdateSPS();
    UpdateUpgradeOverlay(null, null, null);
    updateUpgradesAchievements();
    UpdateStore();
  }
  function distance(x1,y1,x2,y2) {
     return Math.sqrt((x1-x2)*(x1-x2) + (y1-y2)*(y1-y2));
  }
  function GetEdgeLength(r, n) {
    switch(n)
    {
      case 1: return 400;
      case 2: return 350;
      case 3: return 300;
      case 4: return 260;
    }
    var a = (2*Math.PI)/n;
    var tx = Math.cos(a)*r - r;
    var ty = Math.sin(a)*r - 0;
    return Math.pow(ty*ty + tx*tx,0.5*0.95);
  }
  function OrganizePonies() {
    var n = Game.store[0];
    var r=(n>1?260:0);
    var a = (2*Math.PI)/n;
    var th = (n-2)*0.08;
    var html = '';
    var edge = GetEdgeLength(r, n);
    for(var i = 0; i < n; ++i) {
      var pone = ((i<Game.ponyList.length)?Game.ponyList[i]:0);
      html += '<div class="pony" id="pony'+i+'" onclick="Click('+i+');" style="top:'+(Math.sin(a*i + th)*r-(edge/2))+'px;left:'+(Math.cos(a*i + th)*r-(edge/2))+'px;width:'+edge+'px;height:'+edge+'px;background-size: '+edge+'px '+edge+'px;background-image:url(\'./ponies/'+PonyList[pone]+'\');"></div>';
    }
    ponywrapper.innerHTML = html;
        
    // Draw friendship lines
    ctxlines.clearRect(0, 0, canvaslines.width, canvaslines.height);
    ctxlines.beginPath();
    ctxlines.lineWidth="3";
    ctxlines.strokeStyle="#333";
    if(n>1) {
      var f = Game.store[1];
      var k = n-1;
      var j = 0;
      for(var i = 0; i < f; ++i) {
          var p1 = j;
          var p2 = j+k;
          var x1 = Math.cos(a*p1 + th)*r + r;
          var y1 = Math.sin(a*p1 + th)*r + r;
          var x2 = Math.cos(a*p2 + th)*r + r;
          var y2 = Math.sin(a*p2 + th)*r + r;
          ctxlines.moveTo(x1,y1);
          ctxlines.lineTo(x2,y2);
          j += 1;
          if((j+k) >= n) { j=0; k-=1; }
      }
    }
    ctxlines.stroke();
  }
  
  var setShiftDown = function(event){
      if(event.keyCode === 16 || event.charCode === 16){
          Game.shiftDown = true;
      }
  };

  var setShiftUp = function(event){
      if(event.keyCode === 16 || event.charCode === 16){
          Game.shiftDown = false;
      }
  };
  function aniEndFunc() {
    this.parentNode.removeChild(this);
  }
  function ShowMouseText(text,x,y) {
      var div = document.createElement('div'); // We have to do this the hard way because innerHTML forces a re-evaluation of all the elements, replaying all the animations
      div.className = 'mousetext';
      div.style.left = (curMouseX+x)+'px';
      div.style.top = (curMouseY+y)+'px';
      div.innerHTML = '<p>'+text+'</p>';
      div.addEventListener('webkitAnimationEnd', aniEndFunc, false);
      div.addEventListener('animationend', aniEndFunc, false);
      document.getElementById('mousetexts').appendChild(div);
      //document.getElementById('mousetexts').innerHTML += '<div class="mousetext" style="left:'+(curMouseX+x)+'px;top:'+(curMouseY+y)+'px"><p>'+text+'</p></div>';
  }
  function ShowNotice(title, desc, flavor) {
    var div = document.createElement('div');
    div.innerHTML = '<strong>'+title+'</strong>'+(flavor!=null?'<i>['+flavor+']</i>':'') + (desc!=null?'<hr/><p>'+desc+'</p>':'');
    div.addEventListener('webkitAnimationEnd', aniEndFunc, false);
    div.addEventListener('animationend', aniEndFunc, false);
    div.addEventListener('click', aniEndFunc, false);
    var elem = document.getElementById('notices');
    elem.insertBefore(div, elem.firstChild);
  }
  
  function ShowMenu(b) {
    var btn = document.getElementById('menubutton');
    var menu = document.getElementById('menu');
    var board = document.getElementById('ponyboard');
    if(b) {
      btn.style.display = 'none';
      menu.style.display = 'block';
      board.style.paddingLeft = '259px';
    } else {
      btn.style.display = 'inline-block';
      menu.style.display = 'none';
      board.style.paddingLeft = '0';
    }
    ResizeCanvas();
  }
  // You would not believe the horrific sequence of events that led to the creation of this function.
  var setMouseMove = function(event){
    var root = document.getElementById('buy0');
    var wrapper = document.getElementById('storewrapper');
    var item = -1;
    var actualTop = root.offsetTop-wrapper.scrollTop;
    if((event.clientX>wrapper.offsetLeft) && (event.clientY>actualTop)) {
      item = Math.floor((event.clientY - actualTop)/root.offsetHeight);
      if(item >= Store.length) { item = -1; }
    }
    UpdateOverlay(item, event.clientY);
    
    item = -1;
    var upgrades = document.getElementById('storeupgrades');
    actualTop = upgrades.offsetTop-wrapper.scrollTop;
    if((event.clientX>wrapper.offsetLeft) && (event.clientY>actualTop)) {
      item = Math.floor((event.clientY - actualTop)/52)*6 + Math.floor((event.clientX - wrapper.offsetLeft)/52);
      if(item >= Store.length) { item = -1; }
    
    }
    UpdateUpgradeOverlay(item, event.clientX, event.clientY);
    
    curMouseX=event.clientX;
    curMouseY=event.clientY;
    EarnAchievement(1);
  };

  function doOnLoad() {
    document.onmousemove = setMouseMove;
    window.addEventListener? document.addEventListener('keydown', setShiftDown) : document.attachEvent('keydown', setShiftDown);
    window.addEventListener? document.addEventListener('keyup', setShiftUp) : document.attachEvent('keyup', setShiftUp);
    window.onbeforeunload = function (e) {
        if(!Game.settings.closingWarn) { return null; }
        e = e || window.event;
        var text = "You are about to leave Pony Clicker!";
        if (e) { e.returnValue = text; }
        return text;
    };

    InitializeGame();
    ResizeCanvas();
    window.requestAnimationFrame(UpdateGame);
    document.getElementById('loadscreen').style.opacity = 0;
    window.setTimeout(function(){document.getElementById('loadscreen').style.display='none';}, 700);
  }
  </script>
</body>
</html>
